<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>myIOT Demo</title>
    <link href="bootstrap5.1.3.min.css" rel="stylesheet">
    <script src="jquery-3.6.0.min.js"></script>
    <!--script src="bootstrap5.1.3.min.js"></script-->
    <script src="bootstrap5.1.3.bundle.min.js"></script>

    <style>
        .my_nav_link
        {
            color: #ffffff;
        }
        .my_nav_link:hover
        {
            color: #00eeee;
        }
    </style>

    <script type="text/javascript">

        var web_socket;
        var fake_uuid;
        var file_request = 0;


        function fileKB(i)
        {
            var rslt;

            if (i > 1000000000)
            {
                i /= 1000000000;
                rslt = i.toFixed(2) + " GB";
            }
            else if (i > 1000000)
            {
                i /= 1000000;
                rslt = i.toFixed(2) + " MB";
            }
            else if (i > 1000)
            {
                i /= 1000;
                rslt = i.toFixed(2) + " KB";
            }
            else
            {
                rslt = i;
            }
            return rslt;
        }

        function startMyIOT()
        {
            fake_uuid = 'xxxxxxxx'.replace(/[x]/g, (c) => {
                const r = Math.floor(Math.random() * 16);
                return r.toString(16);  });

            web_socket = new WebSocket('ws://' + location.host + ':81');

            web_socket.onopen = function(openEvent) {
                console.log("WebSocket OPEN: " + JSON.stringify(openEvent, null, 4));
                web_socket.send(JSON.stringify({cmd:"spiffs_list"}));
            };

            // web_socket.onclose or onerror  re-open automagically?

            web_socket.onmessage = function (ws_event)
            {
                var ws_msg = ws_event.data;
                console.log("WebSocket MESSAGE: " + ws_msg);

                var obj = JSON.parse(ws_msg);
                if (obj)
                {
                    if (obj.error)
                    {
                        window.alert("ERROR: " + obj.error);
                    }
                    if (obj.device_name)
                    {
                        document.title = obj.device_name;
                        $('#my_brand').html(obj.device_name);
                    }
                    if (obj.version)
                        $('#my_version').html(obj.version);
                    if (obj.iot_version)
                        $('#iot_version').html(obj.iot_version);

                    if (obj.files)
                    {
                        $('table#filemanager tbody').empty();

                        $('#spiffs_used').html(fileKB(obj.used) + " used");
                        $('#spiffs_size').html("of " + fileKB(obj.total) + " total");


                        for (var i=0; i<obj.files.length; i++)
                        {
                            var link = '<a href="/' + obj.files[i].name + '">' + obj.files[i].name + '</a>';
                            var button = "<button onclick='confirmDelete(\"" + obj.files[i].name + "\")'>delete</button>";

                            $('table#filemanager tbody').append(
                                $('<tr />').append(
                                  $('<td />').append(link),
                                  $('<td />').text(obj.files[i].size),
                                  $('<td />').append(button) ));
                        }
                    }
                    if (obj.upload_filename)
                    {
                        var pct = obj.upload_progress;
                        $('#upload_pct').html(obj.upload_progress + "%");
                        $('#upload_filename').html(obj.upload_filename);
                        $("#upload_progress").css("width", obj.upload_progress + "%");

                        if (pct >= 100)
                            $('#upload_progress_dlg').modal('hide');

                        if (obj.upload_error)
                            alert("json error uploading");

                    }
                }
            }
        }


        function uploadFiles(what)
        {
            var files = document.getElementById(what + "_files").files;

            var args = "";
            var total_bytes = 0;
            var formData = new FormData();
            for (var i=0; i<files.length; i++)
            {
                formData.append("uploads", files[i]);
                    // it does not appear to matter what the formdata object is named,
                    // ANY file entries in the post data are treated as file uploads
                    // by the ESP32 WebServer

                // here we pass the filesize as an URL argument,
                // as I still can't see a way to get the post
                // arguments from the webserver .. it is used in
                // my handle_upload() method to verify the final
                // file size

                if (args == "")
                    args += "?";
                else
                    args += "&";
                args += files[i].name + "_size=" + files[i].size;
                total_bytes += files[i].size;
            }

            args += "&num_files=" + files.length;
            args += "&file_request_id=" + fake_uuid + file_request++;

            var xhr = new XMLHttpRequest();
            xhr.timeout = 30000;

            if (what == 'spiffs')
            {
                xhr.onload = function () {
                    web_socket.send(JSON.stringify({cmd:"spiffs_list"})); };
            }
            xhr.ontimeout = function () {
                alert("timeout uploading");
                web_socket.send(JSON.stringify({cmd:"spiffs_list"})); };
            xhr.onerror = function () {
                // alert("error uploading");
                web_socket.send(JSON.stringify({cmd:"spiffs_list"})); };
            // xhr.onprogress = function () {
                // console.log("progress"); };

            if (what == 'ota' || files.length > 2 || total_bytes > 10000)
            {
                $('#upload_filename').html(files[0].name);
                $('#upload_progress_dlg').modal('show');    // {show:true});
                $("#upload_progress").css("width", "0%");
                $('#upload_pct').html("0%");
                $('#upload_num_files').html(files.length);
            }

            xhr.open("POST", "/" + what  + args, true);
            xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');
            xhr.send(formData);
        }


        function onUploadClick() {
            document.getElementById('upload_files').click();
        }
        function onOTAClick() {
            document.getElementById('ota_files').click();
        }

        function confirmDelete(fn)
        {
            if (window.confirm("Confirm deletion of \n" + fn))
            {
                web_socket.send(JSON.stringify({cmd:"spiffs_delete", filename:fn}));
            }
        }
        window.onload = startMyIOT;

    </script>

</head>
<body>


<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <span id='my_brand'>spanmyIOT Demo</span>
            &nbsp;<span id='my_version'>v</span>
            &nbsp;<span id='iot_version'>iot</span>
        </a>
        <ul class="nav nav-dark nav-pills" id="my_nav_buttons" role="tablist">
            <li class="nav-item">
                <button
                    class="nav-link my_nav_link"
                    id="dashboard_button"
                    data-bs-toggle="tab"
                    data-bs-target="#dashboard">
                    Dashboard
                </button>
            </li>
            <li class="nav-item">
                <button
                    class="nav-link my_nav_link"
                    id="config_button"
                    data-bs-toggle="tab"
                    data-bs-target="#config">
                    Config
                </button>
            </li>
            <li class="nav-item">
                <button
                    class="nav-link my_nav_link active"
                    id="spiffs_button"
                    data-bs-toggle="tab"
                    data-bs-target="#spiffs">
                    SPIFFS
                </button>
            </li>
        </ul>
    </div>
</nav>


<div id="my_tab_content" class="tab-content">
    <div id="dashboard" class="tab-pane fade">
        Dashboard
    </div>
    <div id="config" class="tab-pane fade" >
        Config
    </div>
    <div id="spiffs" class="tab-pane fade show active">
        <table class='table' id='filemanager'>
            <thead>
                <tr>
                    <th>
                        Name
                        <label htmlFor="upload_files">
                            <button onclick="onUploadClick()">upload</button>
                        </label>
                        <input type="file" multiple id="spiffs_files" onchange="uploadFiles('spiffs')" style="display:none"/>

                        <label htmlFor="ota_files">
                            <button onclick="onOTAClick()">OTA</button>
                        </label>
                        <input type="file" id="ota_files" onchange="uploadFiles('ota')" style="display:none"/>
                    </th>
                    <th id='spiffs_used'>Size</th>
                    <th id='spiffs_size'>&nbsp;</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>test</td><td>2</td><td>&nbsp;</td></tr>
            </tbody>
        </table>
    </div>
</div>



<div id="upload_progress_dlg"
     class="modal fade"
     data-bs-backdrop="static"
     data-bs-keyboard="false"
     tabindex="-1"
     role="dialog"
     aria-hidden="true">
    <div class="modal-dialog modal-m">
        <div class="modal-content" style='margin-left:30px'>
            <div class="modal-header">
                <h3>Uploading <span id='upload_num_files'>0</span> files ..</h3>
            </div>
            <div class='modal_body' style='margin-left:30px'>
                <div class="d-flex">
                    <div class='progress' style='width:80%;height:28px;'>
                        <div id='upload_progress'
                             class="progress-bar"
                             role="progressbar"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                    &nbsp;&nbsp;
                    <h4 align='right' id="upload_pct"></h4>
                </div>
                <br>
                <h4 id='upload_filename'>filename</h4>
                <br>
                &nbsp;
            </div>
        </div>
   </div>
</div>



</body>
</html>